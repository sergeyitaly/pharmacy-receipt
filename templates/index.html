<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Sales Data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@2.0.0/dist/chartjs-adapter-luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-gradient@1.0.0/dist/chartjs-plugin-gradient.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pharmacy Sales Data</h1>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i> Theme
                </button>
                <button class="view-toggle" onclick="toggleCompact()">
                    <i class="fas fa-compress"></i> Compact
                </button>
            </div>
        </div>

        <div class="totals-grid">
            <div class="total-card">
                <h3>Total Entries</h3>
                <div class="total-value">{{ total_entries }}</div>
            </div>
            <div class="total-card">
                <h3>Total Sales</h3>
                <div class="total-value">{{ "%.2f"|format(totals.total_sales) }} â‚´</div>
            </div>
            <div class="total-card">
                <h3>Items Sold</h3>
                <div class="total-value">{{ totals.total_items }}</div>
            </div>
            <div class="total-card">
                <h3>Unique Products</h3>
                <div class="total-value">{{ totals.unique_products_count }}</div>
            </div>
        </div>

        <!-- Top Selling Products Chart Section -->
        <div class="chart-section">
            <h2>Top 10 Selling Products (Last 7 Days)</h2>
            
            <!-- Add sorting controls here -->
            <div id="chartSortingControls" style="margin: 10px 0; text-align: center;">
                <label style="font-weight: bold; margin-right: 10px;">Sort by:</label>
                <button onclick="renderTopProductsChart('revenue')" 
                        class="sort-btn active" id="sortRevenue">
                    Revenue
                </button>
                <button onclick="renderTopProductsChart('quantity')" 
                        class="sort-btn" id="sortQuantity">
                    Quantity
                </button>
            </div>
            
            {% if top_products and top_products|length > 0 %}
            <div class="chart-container">
                <canvas id="topProductsChart" width="1400" height="700" style="width:100%; height:500px;"></canvas>
            </div>

            <div style="margin: 15px 0; text-align: center;">
                <button onclick="performAIAnalysis()" class="btn btn-primary" id="aiAnalysisBtn">
                    <i class="fas fa-robot"></i> AI Analysis
                </button>
                <div id="aiAnalysisResult" style="margin-top: 15px; padding: 15px; border-radius: 8px; display: none;"></div>
            </div>
            
            <div class="top-products-table">
                <table class="sales-table" id="topProductsTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('topProductsTable', 0, 'number')">
                                Rank <span class="sort-icon"></span>
                            </th>
                            <th class="sortable" onclick="sortTable('topProductsTable', 1, 'text')">
                                Product Name <span class="sort-icon"></span>
                            </th>
                            <th class="sortable" onclick="sortTable('topProductsTable', 2, 'number')">
                                Total Revenue (â‚´) <span class="sort-icon"></span>
                            </th>
                            <th class="sortable" onclick="sortTable('topProductsTable', 3, 'number')">
                                Quantity Sold <span class="sort-icon"></span>
                            </th>
                            <th class="sortable" onclick="sortTable('topProductsTable', 4, 'number')">
                                Occurrences <span class="sort-icon"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in top_products %}
                        <tr>
                            <td data-sort="{{ loop.index }}">{{ loop.index }}</td>
                            <td>{{ product.product_name }}</td>
                            <td data-sort="{{ product.total_revenue }}">{{ "%.2f"|format(product.total_revenue) }} â‚´</td>
                            <td data-sort="{{ product.total_quantity }}">{{ product.total_quantity }}</td>
                            <td data-sort="{{ product.occurrences }}">{{ product.occurrences }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data">
                <p>No sales data available for the last 7 days.</p>
            </div>
            {% endif %}
        </div>

        <div class="actions">
            <a href="{{ url_for('export_csv') }}" class="btn btn-primary">
                <i class="fas fa-download"></i> Export CSV
            </a>
        </div>

        <h2>Sales Records</h2>

        <div style="margin-bottom: 1rem;">
            <input type="text" id="tableSearch" placeholder="Search by product, barcode, or UKTZED..." style="padding: 0.5rem; width: 100%; max-width: 400px;">
        </div>

        <table class="sales-table" id="salesTable">
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTable('salesTable', 0, 'datetime')">
                        Timestamp <span class="sort-icon"></span>
                    </th>
                    <th class="sortable" onclick="sortTable('salesTable', 1, 'text')">
                        Product <span class="sort-icon"></span>
                    </th>
                    <th class="sortable" onclick="sortTable('salesTable', 2, 'text')">
                        UKTZED <span class="sort-icon"></span>
                    </th>
                    <th class="sortable" onclick="sortTable('salesTable', 3, 'text')">
                        Barcode <span class="sort-icon"></span>
                    </th>
                    <th class="sortable" onclick="sortTable('salesTable', 4, 'number')">
                        Quantity <span class="sort-icon"></span>
                    </th>
                    <th class="sortable" onclick="sortTable('salesTable', 5, 'number')">
                        Unit Price <span class="sort-icon"></span>
                    </th>
                    <th class="sortable" onclick="sortTable('salesTable', 6, 'number')">
                        Total Price <span class="sort-icon"></span>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td data-sort="{{ entry.timestamp }}">{{ entry.timestamp[:19] if entry.timestamp else 'N/A' }}</td>
                    <td>{{ entry.sales_data.product_name if entry.sales_data and entry.sales_data.product_name else 'N/A' }}</td>
                    <td>{{ entry.sales_data.uktzed if entry.sales_data and entry.sales_data.uktzed else 'N/A' }}</td>
                    <td>{{ entry.sales_data.barcode if entry.sales_data and entry.sales_data.barcode else 'N/A' }}</td>
                    <td data-sort="{{ entry.sales_data.quantity if entry.sales_data and entry.sales_data.quantity else 0 }}">
                        {{ entry.sales_data.quantity if entry.sales_data and entry.sales_data.quantity else 'N/A' }}
                    </td>
                    <td data-sort="{{ entry.sales_data.unit_price|default(0)|float }}">
                        {% if entry.sales_data and entry.sales_data.unit_price %}
                            {{ "%.2f"|format(entry.sales_data.unit_price|float) }} â‚´
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td data-sort="{{ entry.sales_data.total_price|default(0)|float }}">
                        {% if entry.sales_data and entry.sales_data.total_price %}
                            {{ "%.2f"|format(entry.sales_data.total_price|float) }} â‚´
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn-copy" onclick="copySaleData({{ loop.index0 }})">
                            <i class="fas fa-copy"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center;">No sales data available</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Mobile Cards -->
        {% for entry in entries %}
        <div class="mobile-card">
            <div class="card-row">
                <span class="card-label">Time:</span>
                <span>{{ entry.timestamp[:19] if entry.timestamp else 'N/A' }}</span>
            </div>
            <div class="card-row">
                <span class="card-label">Product:</span>
                <span>{{ entry.sales_data.product_name if entry.sales_data and entry.sales_data.product_name else 'N/A' }}</span>
            </div>
            <div class="card-row">
                <span class="card-label">UKTZED:</span>
                <span>{{ entry.sales_data.uktzed if entry.sales_data and entry.sales_data.uktzed else 'N/A' }}</span>
            </div>
            <div class="card-row">
                <span class="card-label">Barcode:</span>
                <span>{{ entry.sales_data.barcode if entry.sales_data and entry.sales_data.barcode else 'N/A' }}</span>
            </div>
            <div class="card-row">
                <span class="card-label">Qty:</span>
                <span>{{ entry.sales_data.quantity if entry.sales_data and entry.sales_data.quantity else 'N/A' }}</span>
            </div>
            <div class="card-row">
                <span class="card-label">Price:</span>
                <span>
                    {% if entry.sales_data and entry.sales_data.total_price %}
                        {{ "%.2f"|format(entry.sales_data.total_price|float) }} â‚´
                    {% else %}
                        N/A
                    {% endif %}
                </span>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-copy" onclick="copySaleData({{ loop.index0 }})" style="flex: 1;">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </div>
        {% else %}
        <div class="mobile-card">
            <div style="text-align: center;">No sales data available</div>
        </div>
        {% endfor %}

        <div class="footer">
            <p>Last updated: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <p>Auto-refresh every 60 seconds</p>
        </div>
    </div>

    <script>
        // Theme management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.querySelector('.theme-toggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Update chart colors when theme changes
            if (window.currentSortBy) {
                renderTopProductsChart(window.currentSortBy);
            }
        }

        // Compact view
        function toggleCompact() {
            document.body.classList.toggle('compact');
            localStorage.setItem('compact', document.body.classList.contains('compact'));
        }

        // Table Filtering
        document.getElementById("tableSearch").addEventListener("keyup", function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll("#salesTable tbody tr");

            rows.forEach(row => {
                const product = row.cells[1]?.textContent.toLowerCase() || "";
                const uktzed = row.cells[2]?.textContent.toLowerCase() || "";
                const barcode = row.cells[3]?.textContent.toLowerCase() || "";

                if (product.includes(filter) || uktzed.includes(filter) || barcode.includes(filter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });

        // Enhanced Table Sorting
        const sortStates = {};
        
        function sortTable(tableId, columnIndex, dataType) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.rows);
            const header = table.querySelectorAll('thead th')[columnIndex];
            
            // Initialize sort state for this table and column
            if (!sortStates[tableId]) {
                sortStates[tableId] = {};
            }
            
            // Toggle sort direction or set to ascending if new column
            const currentSort = sortStates[tableId][columnIndex];
            const newDirection = currentSort === 'asc' ? 'desc' : 'asc';
            
            // Reset all sort indicators in this table
            table.querySelectorAll('thead th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // Set current column sort indicator
            header.classList.add(`sorted-${newDirection}`);
            sortStates[tableId][columnIndex] = newDirection;
            
            // Sort rows
            rows.sort((a, b) => {
                let valA = a.cells[columnIndex].getAttribute('data-sort') || a.cells[columnIndex].innerText.trim();
                let valB = b.cells[columnIndex].getAttribute('data-sort') || b.cells[columnIndex].innerText.trim();
                
                // Handle N/A values
                if (valA === 'N/A') valA = dataType === 'number' ? -Infinity : '';
                if (valB === 'N/A') valB = dataType === 'number' ? -Infinity : '';
                
                let result = 0;
                
                switch (dataType) {
                    case 'number':
                        const numA = parseFloat(valA) || 0;
                        const numB = parseFloat(valB) || 0;
                        result = numA - numB;
                        break;
                    
                    case 'datetime':
                        // Convert to timestamp for sorting
                        const timeA = new Date(valA).getTime();
                        const timeB = new Date(valB).getTime();
                        result = timeA - timeB;
                        break;
                    
                    case 'text':
                    default:
                        result = valA.localeCompare(valB, undefined, { sensitivity: 'base' });
                        break;
                }
                
                return newDirection === 'asc' ? result : -result;
            });
            
            // Clear and re-append sorted rows
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // Initialize theme, compact view, and sorting
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                const icon = document.querySelector('.theme-toggle i');
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // Load compact view
            if (localStorage.getItem('compact') === 'true') {
                document.body.classList.add('compact');
            }

            // Initialize chart
            initializeChart();

            // Auto-refresh every 60 seconds
            setTimeout(() => {
                location.reload();
            }, 60000);
        });

    function renderTopProductsChart(sortBy = 'revenue') {
        const topProducts = {{ top_products | tojson | safe }};

        if (!topProducts || topProducts.length === 0) {
            console.log('No chart data available');
            return;
        }

        // Store current sort preference
        window.currentSortBy = sortBy;

        // Sort the data based on the selected criteria
        const sortedProducts = [...topProducts].sort((a, b) => {
            if (sortBy === 'quantity') {
                return (b.total_quantity || 0) - (a.total_quantity || 0);
            } else { // default to revenue
                return (b.total_revenue || 0) - (a.total_revenue || 0);
            }
        });

        const ctx = document.getElementById('topProductsChart');

        // Destroy existing chart if exists
        if (window.topProductsChartInstance) {
            window.topProductsChartInstance.destroy();
        }

        // Product names, revenues, and quantities
        const productNames = sortedProducts.map(p =>
            p.product_name.length > 25 ? p.product_name.substring(0, 25) + '...' : p.product_name
        );
        const revenues = sortedProducts.map(p => p.total_revenue || 0);
        const quantities = sortedProducts.map(p => p.total_quantity || 0);

        // Generate rainbow colors
        const colors = [];
        for (let i = 0; i < sortedProducts.length; i++) {
            const hue = Math.floor((i / sortedProducts.length) * 360);
            colors.push(`hsl(${hue}, 70%, 60%)`);
        }

        // Determine the current metric for display
        const currentMetric = sortBy === 'quantity' ? 'Quantity' : 'Revenue (â‚´)';
        const currentData = sortBy === 'quantity' ? quantities : revenues;
        const yAxisTitle = sortBy === 'quantity' ? 'Quantity' : 'Revenue (â‚´)';

        // Get current theme for text colors
        const currentTheme = document.body.getAttribute('data-theme') || 'light';
        const textColor = currentTheme === 'dark' ? '#ffffff' : '#333333';
        const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

        window.topProductsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: productNames,
                datasets: [{
                    label: currentMetric,
                    data: currentData,
                    backgroundColor: colors,
                    borderColor: colors.map(c => c.replace('60%', '40%')),
                    borderWidth: 2,
                    barPercentage: 0.8,
                    categoryPercentage: 0.9
                }]
            },
            options: {
                devicePixelRatio: 2, // Higher DPI for sharper rendering
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 400,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: { 
                        position: 'top',
                        labels: {
                            font: {
                                size: 16, // Increased size
                                family: "'Segoe UI', 'Arial', 'Helvetica', sans-serif",
                                weight: 'bold',
                                lineHeight: 1.4
                            },
                            color: textColor,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 20,
                            boxWidth: 16
                        }
                    },
                    title: {
                        display: true,
                        text: `Top 10 Selling Products (Last 7 Days) - Sorted by ${sortBy.charAt(0).toUpperCase() + sortBy.slice(1)}`,
                        font: { 
                            size: 20, // Increased size
                            weight: 'bold',
                            lineHeight: 1.3
                        },
                        color: textColor,
                        padding: 25
                    },
                    tooltip: {
                        backgroundColor: currentTheme === 'dark' ? 'rgba(0, 0, 0, 0.95)' : 'rgba(255, 255, 255, 0.98)',
                        titleColor: textColor,
                        bodyColor: textColor,
                        titleFont: {
                            size: 14,
                            weight: 'bold',
                            family: "'Segoe UI', 'Arial', sans-serif"
                        },
                        bodyFont: {
                            size: 13,
                            family: "'Segoe UI', 'Arial', sans-serif"
                        },
                        padding: 15,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                return [
                                    `Revenue: â‚´${revenues[index].toFixed(2)}`,
                                    `Quantity: ${quantities[index]}`
                                ];
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'end',
                        color: textColor,
                        font: { 
                            weight: 'bold', 
                            size: 14, // Increased size
                            family: "'Segoe UI', 'Arial', sans-serif"
                        },
                        formatter: (value, ctx) => {
                            return sortBy === 'quantity' ? quantities[ctx.dataIndex] : `â‚´${revenues[ctx.dataIndex].toFixed(0)}`;
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 35,
                            font: { 
                                size: 13, // Increased size
                                family: "'Segoe UI', 'Arial', 'Helvetica', sans-serif",
                                weight: '600'
                            },
                            color: textColor,
                            padding: 10,
                            callback: function(value, index, values) {
                                // Truncate long labels and add ellipsis
                                const label = this.getLabelForValue(value);
                                return label.length > 20 ? label.substring(0, 20) + '...' : label;
                            }
                        },
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: { 
                            display: true, 
                            text: yAxisTitle, 
                            font: { 
                                size: 16, // Increased size
                                family: "'Segoe UI', 'Arial', 'Helvetica', sans-serif",
                                weight: 'bold',
                                lineHeight: 1.4
                            },
                            color: textColor,
                            padding: 20
                        },
                        ticks: {
                            font: {
                                size: 13, // Increased size
                                family: "'Segoe UI', 'Arial', 'Helvetica', sans-serif",
                                weight: '600'
                            },
                            color: textColor,
                            padding: 10
                        },
                        grid: {
                            color: gridColor,
                            drawBorder: false
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        // Update active button states
        updateSortButtons(sortBy);
    }


        function updateSortButtons(activeSort) {
            const revenueBtn = document.getElementById('sortRevenue');
            const quantityBtn = document.getElementById('sortQuantity');
            
            revenueBtn.classList.toggle('active', activeSort === 'revenue');
            quantityBtn.classList.toggle('active', activeSort === 'quantity');
        }

        function initializeChart() {
            renderTopProductsChart('revenue');
        }

        // ðŸŒˆ Gradient helper function
        function getGradient(ctx, chartArea, colorStart, colorEnd) {
            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        }

        // Store entries data for JavaScript access
        const salesData = {{ entries | tojson | safe }};

        function copySaleData(index) {
            if (!salesData || !salesData[index]) {
                showNotification('Sale data not found', 'error');
                return;
            }
            
            const sale = salesData[index];
            const text = `Pharmacy Sale Record:
                    Timestamp: ${sale.timestamp || 'N/A'}
                    Product: ${sale.sales_data?.product_name || 'N/A'}
                    UKTZED: ${sale.sales_data?.uktzed || 'N/A'}
                    Barcode: ${sale.sales_data?.barcode || 'N/A'}
                    Quantity: ${sale.sales_data?.quantity || 'N/A'}
                    Unit Price: ${sale.sales_data?.unit_price || 'N/A'} â‚´
                    Total Price: ${sale.sales_data?.total_price || 'N/A'} â‚´`;
                            
            copyToClipboard(text);
        }

        function copyToClipboard(text) {
            if (!navigator.clipboard) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Copied to clipboard! Ready for ChatGPT analysis.');
                } catch (err) {
                    showNotification('Failed to copy to clipboard', 'error');
                }
                document.body.removeChild(textArea);
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard! Ready for ChatGPT analysis.');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notif => notif.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }


        async function performAIAnalysis() {
    const btn = document.getElementById('aiAnalysisBtn');
    const resultDiv = document.getElementById('aiAnalysisResult');
    const originalText = btn.innerHTML;
    
    try {
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        btn.disabled = true;
        resultDiv.style.display = 'none';

        const topProducts = {{ top_products | tojson | safe }};
        
        if (!topProducts || topProducts.length === 0) {
            throw new Error('No sales data available for analysis');
        }

        // Prepare data for analysis
        const analysisData = topProducts.map(product => ({
            product_name: product.product_name,
            total_quantity: product.total_quantity,
            total_revenue: product.total_revenue
        }));

        // Call Flask backend for AI analysis
        const response = await fetch('/ai-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ products: analysisData })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        // Display results
        resultDiv.innerHTML = `
            <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                <h3 style="margin-top: 0; color: var(--text-color);"><i class="fas fa-chart-line"></i> AI Analysis Results</h3>
                <div style="color: var(--text-color); line-height: 1.6;">${result.analysis}</div>
            </div>
        `;
        resultDiv.style.display = 'block';

    } catch (error) {
        console.error('AI Analysis error:', error);
        resultDiv.innerHTML = `
            <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                <h4 style="margin-top: 0; color: #c62828;"><i class="fas fa-exclamation-triangle"></i> Analysis Error</h4>
                <p style="color: #c62828; margin: 0;">Failed to perform analysis: ${error.message}</p>
            </div>
        `;
        resultDiv.style.display = 'block';
    } finally {
        // Reset button
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
    </script>

</body>
</html>