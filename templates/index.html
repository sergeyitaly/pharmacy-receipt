<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Sales Data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pharmacy Sales Data</h1>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i> Theme
                </button>
                <button class="view-toggle" onclick="toggleCompact()">
                    <i class="fas fa-compress"></i> Compact
                </button>
            </div>
        </div>

        <div class="totals-grid">
            <div class="total-card">
                <h3>Total Entries</h3>
                <div class="total-value">{{ total_entries }}</div>
            </div>
            <div class="total-card">
                <h3>Total Sales</h3>
                <div class="total-value">{{ "%.2f"|format(totals.total_sales) }} ₴</div>
            </div>
            <div class="total-card">
                <h3>Items Sold</h3>
                <div class="total-value">{{ totals.total_items }}</div>
            </div>
            <div class="total-card">
                <h3>Unique Products</h3>
                <div class="total-value">{{ totals.unique_products_count }}</div>
            </div>
        </div>

        <div class="actions">
            <a href="{{ url_for('export_csv') }}" class="btn btn-primary">
                <i class="fas fa-download"></i> Export CSV
            </a>
            <a href="{{ url_for('export_excel') }}" class="btn btn-primary">
                <i class="fas fa-file-excel"></i> Export Excel
            </a>
        </div>

        <h2>Sales Records</h2>

        <div style="margin-bottom: 1rem;">
            <input type="text" id="tableSearch" placeholder="Search by product, barcode, or UKTZED..." style="padding: 0.5rem; width: 100%; max-width: 400px;">
        </div>

        <table class="sales-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Timestamp <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(1)">Product <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(2)">UKTZED <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(3)">Barcode <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(4)">Quantity <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(5)">Unit Price <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(6)">Total Price <i class="fas fa-sort"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
                <tbody>
                    {% for entry in entries %}
                        {% if entry.sales_data is iterable and entry.sales_data is not string %}
                            {% for sale in entry.sales_data %}
                            <tr>
                                <td data-sort="{{ entry.timestamp }}">{{ entry.timestamp[:19] }}</td>
                                <td>{{ sale.product_name or 'N/A' }}</td>
                                <td>{{ sale.uktzed or 'N/A' }}</td>
                                <td>{{ sale.barcode or 'N/A' }}</td>
                                <td>{{ sale.quantity or 'N/A' }}</td>
                                <td data-sort="{{ sale.unit_price|default(0)|float }}">
                                    {% if sale.unit_price %}{{ "%.2f"|format(sale.unit_price|float) }} ₴{% else %}N/A{% endif %}
                                </td>
                                <td data-sort="{{ sale.total_price|default(0)|float }}">
                                    {% if sale.total_price %}{{ "%.2f"|format(sale.total_price|float) }} ₴{% else %}N/A{% endif %}
                                </td>
                                <td>
                                    <a href="{{ entry.url }}" target="_blank" style="margin-right: 0.5rem;">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                    <button class="btn-copy" onclick="copySaleData({{ loop.index0 }})">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td data-sort="{{ entry.timestamp }}">{{ entry.timestamp[:19] }}</td>
                                <td>{{ entry.sales_data.product_name if entry.sales_data else 'N/A' }}</td>
                                <td>{{ entry.sales_data.uktzed if entry.sales_data else 'N/A' }}</td>
                                <td>{{ entry.sales_data.barcode if entry.sales_data else 'N/A' }}</td>
                                <td>{{ entry.sales_data.quantity if entry.sales_data else 'N/A' }}</td>
                                <td data-sort="{{ entry.sales_data.unit_price|default(0)|float }}">
                                    {% if entry.sales_data and entry.sales_data.unit_price %}
                                        {{ "%.2f"|format(entry.sales_data.unit_price|float) }} ₴
                                    {% else %}N/A{% endif %}
                                </td>
                                <td data-sort="{{ entry.sales_data.total_price|default(0)|float }}">
                                    {% if entry.sales_data and entry.sales_data.total_price %}
                                        {{ "%.2f"|format(entry.sales_data.total_price|float) }} ₴
                                    {% else %}N/A{% endif %}
                                </td>
                                <td>
                                    <button class="btn-copy" onclick="copySaleData({{ loop.index0 }})">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endif %}
                    {% else %}
                        <tr>
                            <td colspan="8" style="text-align: center;">No sales data available</td>
                        </tr>
                    {% endfor %}
                </tbody>


        </table>

        <!-- Mobile Cards -->
        {% for entry in entries %}
        <div class="mobile-card">
            <div class="card-row">
                <span class="card-label">Time:</span>
                <span>{{ entry.timestamp[:19] }}</span>
            </div>
            <div class="card-row">
                <span class="card-label">Product:</span>
                <span>{{ entry.sales_data.product_name if entry.sales_data else 'N/A' }}</span>
            </div>
            <div class="card-row">
                <span class="card-label">Price:</span>
                <span>
                    {% if entry.sales_data and entry.sales_data.total_price %}
                        {{ "%.2f"|format(entry.sales_data.total_price | float) }} ₴
                    {% else %}
                        N/A
                    {% endif %}
                </span>
            </div>
            <div class="card-row">
                <span class="card-label">Qty:</span>
                <span>{{ entry.sales_data.quantity if entry.sales_data else 'N/A' }}</span>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <a href="{{ entry.url }}" target="_blank" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-external-link-alt"></i> View
                </a>
                <button class="btn btn-copy" onclick="copySaleData({{ loop.index0 }})" style="flex: 1;">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </div>
        {% else %}
        <div class="mobile-card">
            <div style="text-align: center;">No sales data available</div>
        </div>
        {% endfor %}

        <div class="footer">
            <p>Last updated: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <p>Auto-refresh every 60 seconds</p>
        </div>
    </div>

    <script>
        // Theme management
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.querySelector('.theme-toggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Compact view
        function toggleCompact() {
            document.body.classList.toggle('compact');
            localStorage.setItem('compact', document.body.classList.contains('compact'));
        }

        // Table Filtering
        document.getElementById("tableSearch").addEventListener("keyup", function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll(".sales-table tbody tr");

            rows.forEach(row => {
                const product = row.cells[1]?.textContent.toLowerCase() || "";
                const uktzed = row.cells[2]?.textContent.toLowerCase() || "";
                const barcode = row.cells[3]?.textContent.toLowerCase() || "";

                if (product.includes(filter) || uktzed.includes(filter) || barcode.includes(filter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });

        // Table Sorting
        let sortDirection = {};
        function sortTable(columnIndex) {
            const table = document.querySelector(".sales-table tbody");
            const rows = Array.from(table.rows);

            // Toggle sorting direction
            sortDirection[columnIndex] = !sortDirection[columnIndex];

            rows.sort((a, b) => {
                // Use data-sort attribute if available, otherwise use text content
                let valA = a.cells[columnIndex].getAttribute('data-sort') || a.cells[columnIndex].innerText.trim();
                let valB = b.cells[columnIndex].getAttribute('data-sort') || b.cells[columnIndex].innerText.trim();

                // Convert to numbers if possible
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    // Numeric comparison
                    return sortDirection[columnIndex] ? numA - numB : numB - numA;
                } else {
                    // String comparison (for timestamps and text)
                    if (valA < valB) return sortDirection[columnIndex] ? -1 : 1;
                    if (valA > valB) return sortDirection[columnIndex] ? 1 : -1;
                    return 0;
                }
            });

            // Clear table
            while (table.firstChild) {
                table.removeChild(table.firstChild);
            }

            // Append sorted rows back
            rows.forEach(row => table.appendChild(row));
        }

        // Initialize theme and compact view
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                const icon = document.querySelector('.theme-toggle i');
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            // Load compact view
            if (localStorage.getItem('compact') === 'true') {
                document.body.classList.add('compact');
            }

            // Auto-refresh every 60 seconds
            setTimeout(() => {
                location.reload();
            }, 60000);
        });

        // Store entries data for JavaScript access
        const salesData = {{ entries | tojson }};

        function copySaleData(index) {
            const sale = salesData[index];
            const text = `Pharmacy Sale Record:
Timestamp: ${sale.timestamp}
Product: ${sale.sales_data?.product_name || 'N/A'}
UKTZED: ${sale.sales_data?.uktzed || 'N/A'}
Barcode: ${sale.sales_data?.barcode || 'N/A'}
Quantity: ${sale.sales_data?.quantity || 'N/A'}
Unit Price: ${sale.sales_data?.unit_price || 'N/A'} ₴
Total Price: ${sale.sales_data?.total_price || 'N/A'} ₴
URL: ${sale.url}`;

            copyToClipboard(text);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard! Ready for ChatGPT analysis.');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>